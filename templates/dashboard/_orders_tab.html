{% load static %}
{% load humanize %}

<div class="section-header" data-aos="fade-up">
  <h2>سفارشات من</h2>
  <div class="header-actions">
    <div class="dropdown">
      <button class="filter-btn" data-bs-toggle="dropdown">
        <i class="bi bi-funnel"></i>
        <span>فیلتر</span>
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="?status=">همه سفارشات</a></li>
        <li><a class="dropdown-item" href="?status=paid">پرداخت شده</a></li>
        <li><a class="dropdown-item" href="?status=pending">در انتظار پرداخت</a></li>
        <li><a class="dropdown-item" href="?status=cancelled">لغو شده</a></li>
      </ul>
    </div>
  </div>
</div>

{% if orders %}
<div class="orders-list">
  {% for order in orders %}
  <div class="order-card" data-aos="fade-up">
    <div class="order-header">
      <div class="order-id">
        <span class="label">شماره سفارش:</span>
        <span class="value">#{{ order.order_number }}</span>
      </div>
      <div class="order-date">{{ order.created_date|date:"Y/m/d" }}</div>
    </div>
    <div class="order-content">
      <div class="order-courses">
        {% for item in order.items.all|slice:":3" %}
          {% if item.course.thumbnail %}
            <img src="{{ item.course.thumbnail.url }}" 
                 alt="{{ item.course.title }}" 
                 loading="lazy" />
          {% else %}
            <img src="{% static 'assets/img/logo.webp' %}" 
                 alt="{{ item.course.title }}" 
                 loading="lazy" />
          {% endif %}
        {% endfor %}
        {% if order.items.count > 3 %}
          <div class="more-count">+{{ order.items.count|add:"-3" }}</div>
        {% endif %}
      </div>
      <div class="order-info">
        <div class="info-row">
          <span>وضعیت</span>
          {% if order.is_paid %}
            <span class="status paid">پرداخت شده</span>
          {% elif order.status == 'pending' %}
            <span class="status pending">در انتظار</span>
          {% elif order.status == 'cancelled' %}
            <span class="status cancelled">لغو شده</span>
          {% else %}
            <span class="status">{{ order.get_status_display }}</span>
          {% endif %}
        </div>
        <div class="info-row">
          <span>تعداد دوره‌ها</span>
          <span>{{ order.items.count }} دوره</span>
        </div>
        <div class="info-row">
          <span>مبلغ کل</span>
          <span class="price">{{ order.final_price|floatformat:0|intcomma }} تومان</span>
        </div>
      </div>
    </div>
    <div class="order-footer">
      <a href="{% url 'orders:order_detail' order.id %}" class="btn btn-outline-primary">
        مشاهده جزئیات
      </a>
      {% if order.is_paid %}
        <a href="#courses" data-bs-toggle="tab" class="btn btn-primary">
          <i class="bi bi-mortarboard"></i> دوره‌های من
        </a>
      {% elif order.status == 'pending' %}
        <a href="{% url 'orders:payment' order.id %}" class="btn btn-success">
          <i class="bi bi-credit-card"></i> پرداخت
        </a>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="empty-state text-center py-5">
  <i class="bi bi-receipt" style="font-size: 5rem; color: #ddd;"></i>
  <h3 class="mt-4">سفارشی یافت نشد</h3>
  <p class="text-muted">شما هنوز سفارشی ثبت نکرده‌اید</p>
  <a href="{% url 'courses:course_list' %}" class="btn btn-primary mt-3">
    <i class="bi bi-mortarboard"></i> مشاهده دوره‌ها
  </a>
</div>
{% endif %}
